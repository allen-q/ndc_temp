17/10/2018 03:40:35 - salt_model_v42_deep_supervision_cv_run0 - INFO - np.sum(X_train_ids): 5859769
17/10/2018 03:40:35 - salt_model_v42_deep_supervision_cv_run0 - INFO - np.sum(X_val_ids): 2138231
17/10/2018 03:41:41 - salt_model_v42_deep_supervision_cv_run0 - INFO - salt_model_v42_deep_supervision_cv_run0, based on salt_model_v41_deep_supervision. 4 folds CV.
17/10/2018 03:45:38 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
p = Pipeline_Salt()
p.flip_left_right(probability=0.5)
p.rotate90(0.25)
p.rotate270(0.25)
p.random_brightness(probability=0.5, min_factor=0.8, max_factor=1.2)
p.random_contrast(probability=0.5, min_factor=0.8, max_factor=1.2)
p.rotate_random_align(probability=0.5)
p.crop_random_align(probability=0.5, min_factor=0.6, max_factor=1.0, mask_diff_pct=0.2)

17/10/2018 03:45:38 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
train_data_params = {'batch_size': 32,
                     #'sampler': weighted_sampler,
                     'shuffle': True,
                     'drop_last': True}

val_data_params = {'batch_size': 25,
                   'shuffle': True,
                   'drop_last': False}

train_dataLoader = (
    DataLoader(SaltDataset(X_train, y_train, depth_train,
                           np.zeros_like(X_train_mean_img), out_size=128,  out_ch=1,
                           transform=p.torch_transform()), **train_data_params)
)

val_dataLoader = (
    DataLoader(SaltDataset(X_val, y_val, depth_val, 
                           np.zeros_like(X_train_mean_img), out_size=128, out_ch=1), **val_data_params)
)

dataloaders = {'train': train_dataLoader, 'val':val_dataLoader}

17/10/2018 03:45:38 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
saltnet = UResNet(pretrained=True)
loss_lovasz_hinge = TripleLovaszLoss()
loss_fn_bce = TripleBCELoss(1, 0.05, 0.1)

optimizer = optim.Adam(saltnet.parameters(), lr=1e-4, weight_decay=0.0001)

#scheduler = torch.optim.lr_scheduler.ReduceLROnPlateau(optimizer, mode='min', factor=0.5, patience=5, verbose=True, threshold=0.0001, min_lr=0.00001)
scheduler = PolyLR(optimizer, [1e-4], lr_decay_iter=1, max_iter=150, power=0.9)
model_save_name = model_file_suffix
log.info(model_save_name)

17/10/2018 03:45:38 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
train_params = {
    'model_save_name': model_save_name,
    'save_model_every': 20,
    'save_log_every': 2,
    'num_epochs': 150,
    'log': log,
    'mask_cutoff': 0.,
    'model_save_iou_threshold': 0.82
    }

17/10/2018 03:45:38 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
train_model(saltnet, dataloaders, (loss_fn_bce, loss_lovasz_hinge), (1, 0.3), optimizer, scheduler, train_params, all_data)

17/10/2018 03:45:42 - salt_model_v42_deep_supervision_cv_run0 - INFO - ../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp
17/10/2018 03:45:42 - salt_model_v42_deep_supervision_cv_run0 - INFO - Start Training...
17/10/2018 03:45:42 - salt_model_v42_deep_supervision_cv_run0 - INFO - ({'train': <torch.utils.data.dataloader.DataLoader object at 0x7f9f68c8a3c8>, 'val': <torch.utils.data.dataloader.DataLoader object at 0x7f9f68c8a5f8>}, (TripleBCELoss(), TripleLovaszLoss()), (1, 0.3), Adam (
Parameter Group 0
    amsgrad: False
    betas: (0.9, 0.999)
    eps: 1e-08
    lr: 0.0001
    weight_decay: 0.0001
), <salt_func_lib.PolyLR object at 0x7f9f68d6db38>, {'model_save_name': '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp', 'save_model_every': 20, 'save_log_every': 2, 'num_epochs': 150, 'log': <Logger salt_model_v42_deep_supervision_cv_run0 (DEBUG)>, 'mask_cutoff': 0.0, 'model_save_iou_threshold': 0.82})
17/10/2018 03:45:44 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 1/150
17/10/2018 03:45:44 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 03:58:08 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
p = Pipeline_Salt()
p.flip_left_right(probability=0.5)
p.rotate90(0.25)
p.rotate270(0.25)
p.random_brightness(probability=0.5, min_factor=0.8, max_factor=1.2)
p.random_contrast(probability=0.5, min_factor=0.8, max_factor=1.2)
p.rotate_random_align(probability=0.5)
p.crop_random_align(probability=0.5, min_factor=0.6, max_factor=1.0, mask_diff_pct=0.2)

17/10/2018 03:58:08 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
train_data_params = {'batch_size': 32,
                     #'sampler': weighted_sampler,
                     'shuffle': True,
                     'drop_last': True}

val_data_params = {'batch_size': 25,
                   'shuffle': True,
                   'drop_last': False}

train_dataLoader = (
    DataLoader(SaltDataset(X_train, y_train, depth_train,
                           np.zeros_like(X_train_mean_img), out_size=128,  out_ch=1,
                           transform=p.torch_transform()), **train_data_params)
)

val_dataLoader = (
    DataLoader(SaltDataset(X_val, y_val, depth_val, 
                           np.zeros_like(X_train_mean_img), out_size=128, out_ch=1), **val_data_params)
)

dataloaders = {'train': train_dataLoader, 'val':val_dataLoader}

17/10/2018 03:58:08 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
saltnet = UResNet(pretrained=True)
loss_lovasz_hinge = TripleLovaszLoss()
loss_fn_bce = TripleBCELoss(1, 0.05, 0.1)

optimizer = optim.Adam(saltnet.parameters(), lr=1e-4, weight_decay=0.0001)

#scheduler = torch.optim.lr_scheduler.ReduceLROnPlateau(optimizer, mode='min', factor=0.5, patience=5, verbose=True, threshold=0.0001, min_lr=0.00001)
scheduler = PolyLR(optimizer, [1e-4], lr_decay_iter=1, max_iter=150, power=0.9)
model_save_name = model_file_suffix
log.info(model_save_name)

17/10/2018 03:58:08 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
train_params = {
    'model_save_name': model_save_name,
    'save_model_every': 20,
    'save_log_every': 2,
    'num_epochs': 150,
    'log': log,
    'mask_cutoff': 0.,
    'model_save_iou_threshold': 0.82
    }

17/10/2018 03:58:08 - salt_model_v42_deep_supervision_cv_run0 - INFO - 
train_model_ds(saltnet, dataloaders, (loss_fn_bce, loss_lovasz_hinge), (1, 0.3), optimizer, scheduler, train_params, all_data)

17/10/2018 03:58:09 - salt_model_v42_deep_supervision_cv_run0 - INFO - ../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp
17/10/2018 03:58:09 - salt_model_v42_deep_supervision_cv_run0 - INFO - Start Training...
17/10/2018 03:58:09 - salt_model_v42_deep_supervision_cv_run0 - INFO - ({'train': <torch.utils.data.dataloader.DataLoader object at 0x7f9f65c80c88>, 'val': <torch.utils.data.dataloader.DataLoader object at 0x7f9f65c80d68>}, (TripleBCELoss(), TripleLovaszLoss()), (1, 0.3), Adam (
Parameter Group 0
    amsgrad: False
    betas: (0.9, 0.999)
    eps: 1e-08
    lr: 0.0001
    weight_decay: 0.0001
), <salt_func_lib.PolyLR object at 0x7f9f65bc7a20>, {'model_save_name': '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp', 'save_model_every': 20, 'save_log_every': 2, 'num_epochs': 150, 'log': <Logger salt_model_v42_deep_supervision_cv_run0 (DEBUG)>, 'mask_cutoff': 0.0, 'model_save_iou_threshold': 0.82})
17/10/2018 03:58:09 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 1/150
17/10/2018 03:58:09 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:01:57 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.5083, Acc: 0.8159, Loss: [0.5377, 0.2863, 0.824] at epoch 1
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - ['../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-1-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-2-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-3-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-4-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-5-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-6-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-7-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-8-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-9-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-10-Of-10']
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - Best Val Mean IOU so far: 0.5474000000000001
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.5474, Acc: 0.8697, Best Val IOU: 0.5474 at epoch 1
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.94e-05]
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 2/150
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:02:24 - salt_model_v42_deep_supervision_cv_run0 - INFO - Pushing logs to git.
17/10/2018 04:06:39 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.5658, Acc: 0.8646, Loss: [0.4376, 0.2615, 0.6991] at epoch 2
17/10/2018 04:07:06 - salt_model_v42_deep_supervision_cv_run0 - INFO - ['../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-1-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-2-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-3-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-4-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-5-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-6-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-7-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-8-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-9-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-10-Of-10']
17/10/2018 04:07:06 - salt_model_v42_deep_supervision_cv_run0 - INFO - Best Val Mean IOU so far: 0.6282000000000001
17/10/2018 04:07:06 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.6282, Acc: 0.9048, Best Val IOU: 0.6282 at epoch 2
17/10/2018 04:07:06 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.88e-05]
17/10/2018 04:07:06 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 3/150
17/10/2018 04:07:06 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:10:54 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.6181, Acc: 0.8858, Loss: [0.3836, 0.2311, 0.6147] at epoch 3
17/10/2018 04:11:20 - salt_model_v42_deep_supervision_cv_run0 - INFO - ['../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-1-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-2-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-3-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-4-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-5-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-6-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-7-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-8-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-9-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-10-Of-10']
17/10/2018 04:11:20 - salt_model_v42_deep_supervision_cv_run0 - INFO - Best Val Mean IOU so far: 0.6343
17/10/2018 04:11:20 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.6343, Acc: 0.9084, Best Val IOU: 0.6343 at epoch 3
17/10/2018 04:11:21 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.82e-05]
17/10/2018 04:11:21 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 4/150
17/10/2018 04:11:21 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:11:21 - salt_model_v42_deep_supervision_cv_run0 - INFO - Pushing logs to git.
17/10/2018 04:15:38 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.6290, Acc: 0.8927, Loss: [0.3606, 0.2242, 0.5848] at epoch 4
17/10/2018 04:16:04 - salt_model_v42_deep_supervision_cv_run0 - INFO - ['../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-1-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-2-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-3-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-4-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-5-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-6-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-7-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-8-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-9-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-10-Of-10']
17/10/2018 04:16:04 - salt_model_v42_deep_supervision_cv_run0 - INFO - Best Val Mean IOU so far: 0.6756
17/10/2018 04:16:04 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.6756, Acc: 0.9217, Best Val IOU: 0.6756 at epoch 4
17/10/2018 04:16:04 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.76e-05]
17/10/2018 04:16:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 5/150
17/10/2018 04:16:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:19:53 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.6664, Acc: 0.9047, Loss: [0.3392, 0.2034, 0.5426] at epoch 5
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - ['../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-1-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-2-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-3-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-4-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-5-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-6-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-7-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-8-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-9-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-10-Of-10']
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - Best Val Mean IOU so far: 0.6812
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.6812, Acc: 0.9207, Best Val IOU: 0.6812 at epoch 5
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.7e-05]
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 6/150
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:20:19 - salt_model_v42_deep_supervision_cv_run0 - INFO - Pushing logs to git.
17/10/2018 04:24:39 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.6718, Acc: 0.9054, Loss: [0.3301, 0.1953, 0.5254] at epoch 6
17/10/2018 04:25:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - ['../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-1-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-2-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-3-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-4-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-5-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-6-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-7-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-8-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-9-Of-10', '../salt_net/salt_model_v42_deep_supervision_cv_run0_2018_10_17_14_37_56.ckp-chunk-10-Of-10']
17/10/2018 04:25:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - Best Val Mean IOU so far: 0.7136
17/10/2018 04:25:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.7136, Acc: 0.9371, Best Val IOU: 0.7136 at epoch 6
17/10/2018 04:25:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.64e-05]
17/10/2018 04:25:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 7/150
17/10/2018 04:25:05 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:28:54 - salt_model_v42_deep_supervision_cv_run0 - INFO - Train IOU: 0.6914, Acc: 0.9149, Loss: [0.3095, 0.1885, 0.498] at epoch 7
17/10/2018 04:29:17 - salt_model_v42_deep_supervision_cv_run0 - INFO - Val   IOU: 0.7131, Acc: 0.9301, Best Val IOU: 0.7136 at epoch 7
17/10/2018 04:29:17 - salt_model_v42_deep_supervision_cv_run0 - INFO - LR: [9.58e-05]
17/10/2018 04:29:18 - salt_model_v42_deep_supervision_cv_run0 - INFO - Epoch 8/150
17/10/2018 04:29:18 - salt_model_v42_deep_supervision_cv_run0 - INFO - --------------------
17/10/2018 04:29:18 - salt_model_v42_deep_supervision_cv_run0 - INFO - Pushing logs to git.
